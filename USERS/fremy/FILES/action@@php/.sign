<?php

header('Status: 301 Moved Permanently', false, 301);  
define('C_ADMIN',0);

include_once("ROOT/FUNCTIONS/initialize.php");

global $db;

	//salut
	$userIn = new UserIn();
	$test = $userIn->connectionActivationKey($_GET['act'],false, true);
	if($test === false)
	{
		$activated = 0;
	}
	else
	{
		$activated = 1;
	}


$sql = 'UPDATE '.$GLOBALS['MYSQL_TABLES']['UserIn'].' SET level=1 WHERE activationKey = ?;';
$db->beginTransaction();
$req = $db->prepare($sql);
$req->execute(array($_GET['act'])) or die(print_r($db->errorInfo()));
$sql = 'UPDATE '.$GLOBALS['MYSQL_TABLES']['Comment'].' AS comment SET status = \'visible\' WHERE EXISTS( SELECT * FROM '.$GLOBALS['MYSQL_TABLES']['UserIn'].' as userIn WHERE userIn.activationKey = ? AND userIn.id = comment.userIn_id);';
$req = $db->prepare($sql);
$req->execute(array($_GET['act'])) or die(print_r($db->errorInfo()));
$sql = 'UPDATE '.$GLOBALS['MYSQL_TABLES']['Sond'].' AS comment SET status = \'visible\' WHERE EXISTS( SELECT * FROM '.$GLOBALS['MYSQL_TABLES']['UserIn'].' as userIn WHERE userIn.activationKey = ? AND userIn.nickname = comment.userIn_nickname);';
$req = $db->prepare($sql);
$req->execute(array($_GET['act'])) or die(print_r($db->errorInfo()));
$db->commit();


header('Status: 301 Moved Permanently', false, 301);   
header('Location: index.php?activated='.$activated);   
exit();
?>

